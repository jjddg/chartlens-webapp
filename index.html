<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TG WebApp TEST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #0e0e0e;
      color: #fff;
      font-family: monospace;
      padding: 20px;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    pre {
      margin-top: 20px;
      background: #111;
      padding: 15px;
      border: 1px solid #333;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>
<body>
<script>
alert(
  "Telegram exists: " + !!window.Telegram + "\n" +
  "WebApp exists: " + !!window.Telegram?.WebApp
);
</script>

<h1>üß™ Telegram WebApp TEST</h1>

<button id="btnTest" disabled>Send test request</button>

<pre id="output">Waiting for Telegram WebApp...</pre>

<script>
let TG_USER = null;
const out = document.getElementById("output");
const btn = document.getElementById("btnTest");

function log(msg) {
  out.textContent += "\n" + msg;
}

// 1Ô∏è‚É£ –ñ–¥—ë–º Telegram WebApp
(function waitTelegram() {
  if (window.Telegram && window.Telegram.WebApp) {
    const tg = window.Telegram.WebApp;

    tg.ready();
    tg.expand();

    TG_USER = tg.initDataUnsafe?.user || null;

    log("‚úÖ Telegram WebApp detected");
    log("platform: " + tg.platform);
    log("version: " + tg.version);
    log("user: " + JSON.stringify(TG_USER, null, 2));

    if (TG_USER?.id) {
      btn.disabled = false;
      log("‚úÖ user_id ready: " + TG_USER.id);
    } else {
      log("‚ùå user_id NOT FOUND");
    }

  } else {
    setTimeout(waitTelegram, 50);
  }
})();
</script>

<script>
btn.addEventListener("click", async () => {
  if (!TG_USER?.id) {
    log("‚ùå Cannot send request: no user_id");
    return;
  }

  log("‚û°Ô∏è Sending request to backend...");

  try {
    const res = await fetch("https://ai-signals-backend.onrender.com/analyze", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: TG_USER.id,
        test: true
      })
    });

    const text = await res.text();

    log("‚¨ÖÔ∏è HTTP " + res.status);
    log(text);

  } catch (e) {
    log("üî• Fetch error: " + e.message);
  }
});
</script>

</body>
</html>
